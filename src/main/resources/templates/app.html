<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Audio Transcription</title>
    <style>
        body {
            font-family: Arial;
            background:#f5f5f5;
            padding:40px;
        }
        .card {
            background:white;
            padding:30px;
            max-width:900px;
            margin:auto;
            border-radius:10px;
            box-shadow:0 10px 30px rgba(0,0,0,.1);
        }
        .progress {
            height:24px;
            background:#ddd;
            border-radius:20px;
            overflow:hidden;
            margin-top:15px;
        }
        .bar {
            height:100%;
            width:0%;
            background:linear-gradient(90deg,#4CAF50,#2ecc71);
            transition: width 0.6s ease;
        }
        textarea {
            width:100%;
            height:300px;
            margin-top:20px;
            font-family: monospace;
        }
        button {
            background:#111;
            color:white;
            border:none;
            padding:12px 18px;
            border-radius:6px;
            cursor:pointer;
        }
        .hidden { display:none; }

        .processing {
            font-size: 18px;
            margin-top: 15px;
            font-weight: bold;
        }

        .eta {
            margin-top: 5px;
            color: #555;
        }
    </style>
</head>
<body>

<div class="card">

    <h2>ðŸŽ™ Audio Transcription</h2>

    <!-- UPLOAD -->
    <div id="upload">
        <input type="file" id="file" name="file"/>
        <br><br>
        <button onclick="upload()">Transcribe</button>
    </div>

    <!-- PROGRESS -->
    <div id="progress" class="hidden">
        <div class="processing">
            Processing<span id="dots"></span> please wait
        </div>

        <div class="progress">
            <div class="bar" id="bar"></div>
        </div>

        <p id="chunks"></p>
        <p class="eta" id="eta"></p>
    </div>

    <!-- RESULT -->
    <div id="result" class="hidden">
        <h3>Transcription</h3>
        <textarea id="text"></textarea>
        <br><br>
        <button onclick="location.reload()">New transcription</button>
    </div>

</div>

<script>
    let jobId = null;
    let dotCount = 0;

    function upload() {
        const f = document.getElementById("file").files[0];
        if (!f) {
            alert("Please select a file");
            return;
        }

        const fd = new FormData();
        fd.append("file", f);

        fetch("/upload", {method:"POST", body: fd})
            .then(r=>r.text())
            .then(id=>{
                jobId=id;
                document.getElementById("upload").classList.add("hidden");
                document.getElementById("progress").classList.remove("hidden");
                animateDots();
                poll();
            });
    }

    function animateDots() {
        dotCount = (dotCount + 1) % 4;
        document.getElementById("dots").innerText = ".".repeat(dotCount);
        setTimeout(animateDots, 500);
    }

    function poll() {
        fetch("/api/job/" + jobId)
            .then(r=>r.json())
            .then(j=>{
                if (j.totalChunks > 0) {
                    const percent = Math.round((j.doneChunks / j.totalChunks) * 100);
                    document.getElementById("bar").style.width = percent + "%";
                    document.getElementById("chunks").innerText =
                        j.doneChunks + " / " + j.totalChunks + " (" + percent + "%)";

                    const remaining = j.totalChunks - j.doneChunks;
                    const minutes = remaining * 4;
                    const h = Math.floor(minutes / 60);
                    const m = minutes % 60;

                    document.getElementById("eta").innerText =
                        "Estimated time remaining: " +
                        (h > 0 ? h + "h " : "") + m + " min";
                }

                if (j.status === "DONE") {
                    document.getElementById("progress").classList.add("hidden");
                    document.getElementById("result").classList.remove("hidden");
                    document.getElementById("text").value = j.result.original;
                }
                else if (j.status === "FAILED") {
                    alert(j.error);
                }
                else {
                    setTimeout(poll, 2000);
                }
            });
    }
</script>

</body>
</html>
