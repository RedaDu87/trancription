<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Audio Transcription</title>
    <style>
        body {
            font-family: Arial;
            background:#f5f5f5;
            padding:40px;
        }
        .card {
            background:white;
            padding:30px;
            max-width:900px;
            margin:auto;
            border-radius:10px;
            box-shadow:0 10px 30px rgba(0,0,0,.1);
        }
        .progress {
            height:24px;
            background:#ddd;
            border-radius:20px;
            overflow:hidden;
            margin-top:15px;
        }
        .bar {
            height:100%;
            width:0%;
            background:linear-gradient(90deg,#4CAF50,#2ecc71);
            transition: width 0.6s ease;
        }
        textarea {
            width:100%;
            height:300px;
            margin-top:20px;
            font-family: monospace;
        }
        button {
            background:#111;
            color:white;
            border:none;
            padding:12px 18px;
            border-radius:6px;
            cursor:pointer;
        }
        .hidden { display:none; }
    </style>
</head>
<body>

<div class="card">

    <h2>ðŸŽ™ Audio Transcription</h2>

    <!-- UPLOAD -->
    <div id="upload">
        <input type="file" id="file"/>
        <br><br>
        <button onclick="upload()">Transcrire</button>
    </div>

    <!-- PROGRESS -->
    <div id="progress" class="hidden">
        <p id="status"></p>
        <div class="progress">
            <div class="bar" id="bar"></div>
        </div>
        <p id="chunks"></p>
    </div>

    <!-- RESULT -->
    <div id="result" class="hidden">
        <h3>Transcription</h3>
        <textarea id="text"></textarea>
        <br><br>
        <button onclick="location.reload()">Nouvelle transcription</button>
    </div>

</div>

<script>
    let jobId = null;

    function upload() {
        const f = document.getElementById("file").files[0];
        const fd = new FormData();
        fd.append("file", f);

        fetch("/upload", {method:"POST", body: fd})
            .then(r=>r.text())
            .then(id=>{
                jobId=id;
                document.getElementById("upload").classList.add("hidden");
                document.getElementById("progress").classList.remove("hidden");
                poll();
            });
    }

    function poll() {
        fetch("/api/job/" + jobId)
            .then(r=>r.json())
            .then(j=>{
                document.getElementById("status").innerText = j.status;

                if (j.totalChunks > 0) {
                    const percent = Math.round((j.doneChunks / j.totalChunks) * 100);
                    document.getElementById("bar").style.width = percent + "%";
                    document.getElementById("chunks").innerText =
                        j.doneChunks + " / " + j.totalChunks + " (" + percent + "%)";
                }

                if (j.status === "DONE") {
                    document.getElementById("progress").classList.add("hidden");
                    document.getElementById("result").classList.remove("hidden");
                    document.getElementById("text").value = j.result.original;
                }
                else if (j.status === "FAILED") {
                    alert(j.error);
                }
                else {
                    setTimeout(poll, 2000);
                }
            });
    }
</script>

</body>
</html>
